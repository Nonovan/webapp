# Web Application Firewall rules for Cloud Infrastructure Platform
# Additional custom rules for ModSecurity

# Block common attack patterns
SecRule REQUEST_LINE "@rx (?:(?:\\.\\./)|(?:\\.\\.\\\\))" \\
    "id:10001,phase:1,t:none,t:urlDecodeUni,t:normalizePathWin,log,deny,status:403,msg:'Path Traversal Attack'"

# Block common SQL Injection vectors
SecRule ARGS|ARGS_NAMES|REQUEST_COOKIES|REQUEST_COOKIES_NAMES "@rx (?:(?:select\\s+.*\\s*from)|(?:union\\s+.*\\s*select)|(?:insert\\s+into.*values)|(?:update\\s+.*\\s+set)|(?:delete\\s+from))" \\
    "id:10002,phase:2,t:none,t:lowercase,log,deny,status:403,msg:'SQL Injection Attempt'"

# Block XSS attacks
SecRule REQUEST_COOKIES|REQUEST_COOKIES_NAMES|ARGS|ARGS_NAMES "@rx (?:<script[^>]*>|<iframe[^>]*>|javascript:)" \\
    "id:10003,phase:2,t:none,t:urlDecodeUni,log,deny,status:403,msg:'XSS Attack'"

# Block file inclusion attempts
SecRule ARGS|ARGS_NAMES "@rx (?:(?:https?|ftp|php|data|file)://)" \\
    "id:10004,phase:2,t:none,t:lowercase,log,deny,status:403,msg:'Remote File Inclusion'"

# Block server-side request forgery attempts
SecRule ARGS|ARGS_NAMES "@rx (?:localhost|127\\.0\\.0\\.1|\\[::1\\])" \\
    "id:10005,phase:2,t:none,t:lowercase,log,deny,status:403,msg:'SSRF Attempt'"

# Block common shell commands
SecRule ARGS|ARGS_NAMES "@rx (?:(?:/bin/)|(?:/etc/)|(?:;.*?(?:cat|echo|curl|wget|whoami)))" \\
    "id:10006,phase:2,t:none,t:lowercase,log,deny,status:403,msg:'OS Command Injection'"

# Block common sensitive files
SecRule REQUEST_URI "@rx \\.(env|sql|git|svn|htaccess|htpasswd)$" \\
    "id:10007,phase:1,t:none,t:lowercase,log,deny,status:403,msg:'Sensitive File Access'"

# Block malicious user agents
SecRule REQUEST_HEADERS:User-Agent "@rx (?:nikto|sqlmap|nessus|netsparker|acunetix|metasploit)" \\
    "id:10008,phase:1,t:none,t:lowercase,log,deny,status:403,msg:'Penetration Testing Tool'"

# Rate limit login attempts
SecRule REQUEST_URI "@streq /login" \\
    "id:10009,phase:1,t:none,nolog,pass,setvar:ip.login_attempt=+1,expirevar:ip.login_attempt=60"

SecRule IP:LOGIN_ATTEMPT "@gt 5" \\
    "id:10010,phase:1,t:none,log,deny,status:429,msg:'Login Rate Limit Exceeded'"

# Special protection for API endpoints
SecRule REQUEST_URI "@beginsWith /api/" \\
    "id:10011,phase:1,t:none,nolog,pass,setvar:ip.api_request=+1,expirevar:ip.api_request=60"

SecRule IP:API_REQUEST "@gt 60" \\
    "id:10012,phase:1,t:none,log,deny,status:429,msg:'API Rate Limit Exceeded'"

# Block requests with suspiciously large payloads to specific endpoints
SecRule REQUEST_URI "@rx ^/api/(auth|users|security)" \\
    "id:10013,phase:1,t:none,chain"
SecRule REQUEST_HEADERS:Content-Length "@gt 10000" \\
    "t:none,log,deny,status:413,msg:'Request Entity Too Large'"

# JSON body inspection
SecRule REQUEST_HEADERS:Content-Type "@contains application/json" \\
    "id:10014,phase:1,t:none,pass,nolog,ctl:requestBodyProcessor=JSON"

SecRule REQUEST_BODY "@rx (?:((\\\\'|\\\\\\")?__proto__(\\\\\\'|\\\\\\")?)|((\\\\'|\\\\\\")?constructor(\\\\\\'|\\\\\\")?))" \\
    "id:10015,phase:2,t:none,t:lowercase,log,deny,status:403,msg:'Prototype Pollution Attack'"
