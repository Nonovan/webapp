# API Configuration for Cloud Infrastructure Platform
# This file defines the API endpoints and their routing

# Upstream definition for API backend servers
upstream backend_api {
    # Use IP hash for session persistence
    ip_hash;
    
    # Main backend servers
    server 127.0.0.1:5000 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:5001 max_fails=3 fail_timeout=30s backup;
    
    # Keepalive connections
    keepalive 32;
}

# API rate limiting zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=auth_limit:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=webhooks:10m rate=20r/s;

# API endpoint configuration
location /api/ {
    # Include common proxy parameters
    include conf.d/proxy-params.conf;
    
    # Apply rate limiting with burst
    limit_req zone=api_limit burst=20 nodelay;
    
    # Add API request ID for tracing
    proxy_set_header X-Request-ID $request_id;
    
    # Security headers
    include conf.d/security-headers.conf;
    
    # Proxy to backend
    proxy_pass http://backend_api;
    
    # Override timeout for API requests
    proxy_read_timeout 60s;
    proxy_connect_timeout 60s;
    
    # Enable WebSocket support for specific endpoints
    location /api/ws {
        include conf.d/websocket.conf;
    }
    
    # Authentication endpoints may need special handling
    location /api/auth/ {
        # Apply stricter rate limiting for auth endpoints
        limit_req zone=auth_limit burst=10 nodelay;
        proxy_pass http://backend_api;
        proxy_read_timeout 30s;
    }
    
    # Cloud provider integration endpoints
    location /api/cloud/ {
        proxy_pass http://backend_api;
        proxy_read_timeout 120s;  # Longer timeout for cloud operations
    }
    
    # Webhook endpoints
    location /api/webhooks/ {
        limit_req zone=webhooks burst=30 nodelay;
        proxy_pass http://backend_api;
        # Higher timeout for webhook processing
        proxy_read_timeout 90s;
    }
    
    # Industrial Control Systems (ICS) endpoints with restricted access
    location /api/ics/ {
        # Allow only specific IP ranges
        allow 10.100.0.0/16;
        allow 192.168.10.0/24;
        deny all;
        
        proxy_pass http://backend_api;
        proxy_read_timeout 300s;  # Extended timeout for ICS operations
    }
    
    # Newsletter subscription endpoint
    location /api/newsletter/ {
        proxy_pass http://backend_api;
        # Anti-spam measures
        limit_req zone=api_limit burst=5;
    }
}

# Deny access to sensitive API endpoints from public internet
location ~ ^/api/(admin|internal)/ {
    # Allow internal requests only
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    deny all;
    
    proxy_pass http://backend_api;
    include conf.d/proxy-params.conf;
}

# API documentation
location /api/docs {
    proxy_pass http://backend_api;
    include conf.d/proxy-params.conf;
    include conf.d/security-headers.conf;
    
    # Cache documentation
    proxy_cache api_cache;
    proxy_cache_valid 200 10m;
    add_header X-Cache-Status $upstream_cache_status;
}