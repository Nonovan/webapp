# WebSocket Configuration for Cloud Infrastructure Platform
# This file should be included in the NGINX server block

# WebSocket support for /api/ws endpoints
location /api/ws {
    proxy_pass http://backend_api;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
    
    # Security settings
    proxy_buffering off;
    
    # Rate limiting zone for WebSocket connections
    limit_req zone=websocket burst=5;
}

# Configuration for ICS WebSocket endpoints with additional security
location /api/ics/ws {
    # IP restriction to allow only specific networks
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    
    proxy_pass http://backend_api;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    
    # Security settings
    proxy_buffering off;
    
    # Add special ICS headers
    proxy_set_header X-ICS-Connection true;
}

# Configuration for monitoring WebSocket endpoints
location /api/monitoring/ws {
    # JWT authentication required
    auth_request /auth/validate;
    
    proxy_pass http://backend_api;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
    proxy_send_timeout 300s;
}