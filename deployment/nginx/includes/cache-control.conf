# Cache Control Configuration for Cloud Infrastructure Platform
# Include this file in location blocks to implement appropriate caching policies

# Define cache-control based on file type
map $sent_http_content_type $cache_control {
    default                           "no-store, no-cache, must-revalidate";
    
    # Cache static assets aggressively
    text/css                          "public, max-age=31536000, immutable";
    text/javascript                   "public, max-age=31536000, immutable";
    application/javascript            "public, max-age=31536000, immutable";
    
    # Cache images aggressively
    image/svg+xml                     "public, max-age=31536000, immutable";
    image/webp                        "public, max-age=31536000, immutable";
    image/png                         "public, max-age=31536000, immutable";
    image/jpeg                        "public, max-age=31536000, immutable";
    image/gif                         "public, max-age=31536000, immutable";
    image/x-icon                      "public, max-age=31536000, immutable";
    image/vnd.microsoft.icon          "public, max-age=31536000, immutable";
    
    # Cache fonts aggressively
    font/woff                         "public, max-age=31536000, immutable";
    font/woff2                        "public, max-age=31536000, immutable";
    application/font-woff             "public, max-age=31536000, immutable";
    application/font-woff2            "public, max-age=31536000, immutable";
    
    # Cache HTML briefly
    text/html                         "public, max-age=900";
    
    # API responses - do not cache by default
    application/json                  "no-store, no-cache, must-revalidate";
    application/xml                   "no-store, no-cache, must-revalidate";
}

# Define cache-control based on URI patterns
map $request_uri $uri_cache_control {
    default                          "";
    # Never cache these URIs regardless of content type
    ~*^/api/                         "no-store, no-cache, must-revalidate";
    ~*^/admin/                       "no-store, no-cache, must-revalidate, private";
    ~*^/auth/                        "no-store, no-cache, must-revalidate, private";
    
    # Cache static assets with versioning parameter (e.g. ?v=123)
    ~*\.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2)(\?v=.+)$   "public, max-age=31536000, immutable";
}

# Add appropriate Cache-Control header
add_header Cache-Control $uri_cache_control;
# Fallback to content-type based cache if no URI match
add_header Cache-Control $cache_control if_empty;

# ETag and Last-Modified settings
etag on;
if_modified_since exact;

# Set Expires headers based on content type
expires $cache_control;

# Vary header settings for proper caching
add_header Vary "Accept-Encoding, Origin" always;

# Usage examples:
#
# location /static/ {
#     include includes/cache-control.conf;
# }
#
# location /api/ {
#     add_header Cache-Control "no-store, no-cache, must-revalidate" always;
# }