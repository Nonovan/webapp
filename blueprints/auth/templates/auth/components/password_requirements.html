{#
 # Password requirements component for the Cloud Infrastructure Platform
 #
 # This reusable component displays password strength requirements with visual feedback
 # based on NIST 800-63B guidelines and the platform's security policy.
 #
 # Usage:
 # {% include "auth/components/password_requirements.html" with context %}
 #
 # Required context:
 #  - password_input_id: ID of the password input element to monitor
 #  - show_meter: Boolean to show/hide the visual strength meter (default: true)
 #
 # Optional context:
 #  - custom_class: Additional CSS classes for the container
 #  - custom_id_prefix: Prefix for generated IDs (default: "pwd")
 #  - requirement_class: CSS class for requirement items (default: "small text-muted mb-2")
 #}

{# Set default values if not provided #}
{% set show_meter = show_meter|default(true) %}
{% set custom_id_prefix = custom_id_prefix|default("pwd") %}
{% set requirement_class = requirement_class|default("small text-muted mb-2") %}

{# Generate unique IDs for the component elements #}
{% set requirements_id = custom_id_prefix + "-requirements" %}
{% set strength_meter_id = custom_id_prefix + "-strength" %}
{% set strength_text_id = custom_id_prefix + "-strength-text" %}

{# Password requirements list #}
<ul id="{{ requirements_id }}" class="{{ requirement_class }}">
    <li data-requirement="length">Must be at least 12 characters</li>
    <li data-requirement="lowercase">Must include lowercase letters (a-z)</li>
    <li data-requirement="uppercase">Must include uppercase letters (A-Z)</li>
    <li data-requirement="number">Must include numbers (0-9)</li>
    <li data-requirement="special">Must include special characters (!@#$%, etc.)</li>
</ul>

{# Strength meter (optional) #}
{% if show_meter %}
<div class="mb-2">
    <div id="{{ strength_meter_id }}" class="progress" style="height: 5px;" role="progressbar"
         aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progress-bar" style="width: 0%"></div>
    </div>
    <small id="{{ strength_text_id }}" class="form-text text-muted">Password strength: Too weak</small>
</div>
{% endif %}

{# Inline script with CSP nonce to initialize the component #}
{% if csp_nonce %}
<script nonce="{{ csp_nonce }}">
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the password requirements feedback
        if (window.setupPasswordRequirementsFeedback) {
            setupPasswordRequirementsFeedback(
                '{{ password_input_id }}',
                '{{ requirements_id }}'
            );
        }

        // Initialize the strength meter if enabled
        {% if show_meter %}
        if (window.setupPasswordStrengthMeter) {
            setupPasswordStrengthMeter(
                '{{ password_input_id }}',
                '#{{ strength_meter_id }} .progress-bar',
                '#{{ strength_text_id }}'
            );
        }
        {% endif %}
    });
</script>
{% endif %}

{# Accessibility-enhancing ARIA description #}
<div class="visually-hidden" id="{{ requirements_id }}-description">
    Password must be at least 12 characters long, include lowercase and uppercase letters,
    numbers, and special characters. Avoid common patterns and repeated characters.
</div>

{# Add the ARIA attribute to the password field via script to prevent validation issues #}
{% if csp_nonce %}
<script nonce="{{ csp_nonce }}">
    document.addEventListener('DOMContentLoaded', function() {
        const passwordInput = document.getElementById('{{ password_input_id }}');
        if (passwordInput) {
            passwordInput.setAttribute('aria-describedby', '{{ requirements_id }}-description');
        }
    });
</script>
{% endif %}
