backup_codes.html -->
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Security headers -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), microphone=(), payment=()">

    <title>MFA Backup Codes - Cloud Infrastructure Platform</title>

    <!-- Bootstrap and custom styles with SRI -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}"
          integrity="{{ sri_hash('css/bootstrap.min.css') }}" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap-icons.css') }}"
          integrity="{{ sri_hash('css/bootstrap-icons.css') }}" crossorigin="anonymous">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"
          integrity="{{ sri_hash('css/style.css') }}" crossorigin="anonymous">

    <style>
        .backup-code {
            font-family: monospace;
            font-size: 1.2rem;
            letter-spacing: 0.1rem;
            background-color: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            border: 1px solid #dee2e6;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .backup-code.used {
            text-decoration: line-through;
            opacity: 0.6;
        }
        [data-bs-theme="dark"] .backup-code {
            background-color: #343a40;
            border-color: #495057;
        }
        .copy-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #6c757d;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }
        .copy-btn:hover {
            background-color: rgba(108, 117, 125, 0.1);
        }
        .copy-btn:focus {
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }
        .download-area {
            border-top: 1px solid #dee2e6;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .page-break {
                page-break-after: always;
            }
            body {
                padding: 0;
                margin: 2cm;
            }
        }
    </style>
</head>

<body data-bs-theme="{{ theme|default('light') }}">
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="skip-link visually-hidden-focusable">Skip to main content</a>

    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="card shadow-sm">
                    <div class="card-body p-md-5" id="main-content">
                        <div class="d-flex align-items-center mb-4">
                            <i class="bi bi-shield-lock-fill text-primary me-3" style="font-size: 2rem;"></i>
                            <h1 class="card-title mb-0">MFA Backup Codes</h1>
                        </div>

                        <div class="alert alert-warning d-flex align-items-center" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                <strong>Important:</strong> These backup codes will only be shown once.
                                Please save them in a secure location.
                            </div>
                        </div>

                        <p class="mb-4">
                            If you lose access to your authentication app, you can use one of these backup codes to sign in.
                            Each code can be used only once.
                        </p>

                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h2 class="h5 mb-0">Your Backup Codes</h2>
                                <div class="btn-group no-print">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="copyAllBtn"
                                            onclick="copyAllCodes()" aria-label="Copy all codes">
                                        <i class="bi bi-clipboard me-1"></i> Copy All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()"
                                            aria-label="Print backup codes">
                                        <i class="bi bi-printer me-1"></i> Print
                                    </button>
                                </div>
                            </div>

                            <div class="row">
                                {% if backup_codes %}
                                    {% for code in backup_codes %}
                                        <div class="col-md-6">
                                            <div class="backup-code" id="code-{{ loop.index }}">
                                                <span>{{ code }}</span>
                                                <button type="button" class="copy-btn no-print"
                                                        onclick="copyCode('{{ code }}')"
                                                        aria-label="Copy code {{ code }}"
                                                        title="Copy to clipboard">
                                                    <i class="bi bi-clipboard"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-danger">
                                            No backup codes available. Please contact support.
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="alert alert-info d-flex" role="alert">
                            <i class="bi bi-info-circle-fill me-2 flex-shrink-0"></i>
                            <div>
                                Store these codes somewhere safe but accessible, such as a password manager.
                                Each code can only be used once for authentication.
                            </div>
                        </div>

                        <div class="download-area">
                            <h3 class="h5 mb-3">Download Options</h3>
                            <div class="d-flex flex-wrap gap-2 no-print">
                                <button type="button" class="btn btn-outline-primary" id="downloadTxtBtn"
                                        onclick="downloadCodes('txt')" aria-label="Download as text file">
                                    <i class="bi bi-file-text me-2"></i>Download as Text
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="downloadPdfBtn"
                                        onclick="downloadCodes('pdf')" aria-label="Download as PDF">
                                    <i class="bi bi-file-pdf me-2"></i>Download as PDF
                                </button>
                            </div>
                        </div>

                        <div class="mt-4 no-print">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('main.profile') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left me-2"></i>Back to Profile
                                </a>
                                <form action="{{ url_for('auth.regenerate_backup_codes') }}" method="post" class="d-inline">
                                    {{ csrf_token() }}
                                    <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal"
                                            data-bs-target="#regenerateConfirmModal">
                                        <i class="bi bi-arrow-repeat me-2"></i>Generate New Codes
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-4 shadow-sm no-print">
                    <div class="card-body">
                        <h3 class="h5"><i class="bi bi-question-circle me-2"></i>What are backup codes?</h3>
                        <p class="mb-0">
                            Backup codes are one-time use codes that allow you to sign in to your account when you don't
                            have access to your authentication app. You should store these codes securely, as anyone with
                            access to them could potentially access your account.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Regenerate Confirmation Modal -->
    <div class="modal fade" id="regenerateConfirmModal" tabindex="-1" aria-labelledby="regenerateConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="regenerateConfirmModalLabel">Confirm Regeneration</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Warning:</strong> This will invalidate all your existing backup codes.
                    </div>
                    <p>
                        Are you sure you want to generate new backup codes? Your current backup codes will no longer work.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{{ url_for('auth.regenerate_backup_codes') }}" method="post">
                        {{ csrf_token() }}
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-arrow-repeat me-2"></i>Generate New Codes
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Print template that only shows when printing -->
    <div class="d-none d-print-block">
        <div class="page-break">
            <h1 class="mb-4">MFA Backup Codes - {{ g.user.username }}</h1>
            <p>Generated on: {{ now().strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <p>For account: {{ g.user.email }}</p>

            <div class="mt-4">
                <h2>Your Backup Codes</h2>
                <ul style="list-style-type: none; padding-left: 0;">
                    {% if backup_codes %}
                        {% for code in backup_codes %}
                            <li style="font-family: monospace; font-size: 1.2rem; margin-bottom: 0.5rem;">{{ code }}</li>
                        {% endfor %}
                    {% endif %}
                </ul>
            </div>

            <div style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
                <h3>Instructions:</h3>
                <ol>
                    <li>Store these codes in a secure but accessible location.</li>
                    <li>Each code can only be used once.</li>
                    <li>If you lose access to your authentication app, use one of these codes to sign in.</li>
                    <li>Once you've used all your backup codes, you'll need to generate new ones.</li>
                    <li>If you lose your device and all backup codes, contact support for assistance.</li>
                </ol>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS with SRI -->
    <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"
            integrity="{{ sri_hash('js/bootstrap.bundle.min.js') }}" crossorigin="anonymous"></script>

    <!-- Inline scripts with nonce for CSP -->
    <script nonce="{{ csp_nonce }}">
        // Copy a single backup code
        function copyCode(code) {
            navigator.clipboard.writeText(code)
                .then(() => {
                    showToast('Code copied to clipboard', 'success');
                })
                .catch(err => {
                    console.error('Failed to copy code: ', err);
                    showToast('Failed to copy code', 'danger');
                });
        }

        // Copy all backup codes as a formatted text
        function copyAllCodes() {
            {% if backup_codes %}
                const allCodes = [{% for code in backup_codes %}"{{ code }}"{% if not loop.last %}, {% endif %}{% endfor %}];
                const formattedCodes = "MFA Backup Codes - {{ g.user.username }}\n" +
                                      "Generated: {{ now().strftime('%Y-%m-%d') }}\n\n" +
                                      allCodes.join("\n");

                navigator.clipboard.writeText(formattedCodes)
                    .then(() => {
                        showToast('All codes copied to clipboard', 'success');
                    })
                    .catch(err => {
                        console.error('Failed to copy all codes: ', err);
                        showToast('Failed to copy codes', 'danger');
                    });
            {% endif %}
        }

        // Download backup codes in different formats
        function downloadCodes(format) {
            {% if backup_codes %}
                const allCodes = [{% for code in backup_codes %}"{{ code }}"{% if not loop.last %}, {% endif %}{% endfor %}];
                const header = "MFA Backup Codes - {{ g.user.username }}\n" +
                              "Generated: {{ now().strftime('%Y-%m-%d') }}\n\n";
                const content = header + allCodes.join("\n");

                if (format === 'txt') {
                    const blob = new Blob([content], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'mfa_backup_codes.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast('Codes downloaded as text file', 'success');
                } else if (format === 'pdf') {
                    // For PDF, we'll use the print functionality
                    window.print();
                }
            {% else %}
                showToast('No backup codes available to download', 'danger');
            {% endif %}
        }

        // Show toast notification
        function showToast(message, type) {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                // Create toast container if it doesn't exist
                const container = document.createElement('div');
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(container);
            }

            const toastElement = document.createElement('div');
            toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
            toastElement.setAttribute('role', 'alert');
            toastElement.setAttribute('aria-live', 'assertive');
            toastElement.setAttribute('aria-atomic', 'true');

            toastElement.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            document.querySelector('.toast-container').appendChild(toastElement);
            const toast = new bootstrap.Toast(toastElement, { autohide: true, delay: 3000 });
            toast.show();

            // Remove the toast from DOM after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }

        // Security: Add event listener only if clipboard API is available
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.clipboard) {
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.disabled = true;
                    btn.title = 'Clipboard not supported in your browser';
                });

                document.getElementById('copyAllBtn').disabled = true;
                document.getElementById('copyAllBtn').title = 'Clipboard not supported in your browser';
            }
        });
    </script>

    <!-- Toast container -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>
</body>
</html>
