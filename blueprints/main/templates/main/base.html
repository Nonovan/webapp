<!doctype html>
<html lang="en" dir="ltr" data-bs-theme="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- Security headers -->
        <meta
            http-equiv="Content-Security-Policy"
            content="default-src 'self' https:"
        />
        <meta http-equiv="X-Frame-Options" content="DENY" />
        <meta http-equiv="X-Content-Type-Options" content="nosniff" />

        <!-- Application metadata -->
        <meta
            name="description"
            content="Cloud infrastructure management platform"
        />
        <meta name="theme-color" content="#0066cc" />

        <title>{% block title %}Cloud Service{% endblock %}</title>

        <!-- Resource hints -->
        <link rel="preconnect" href="https://cdn.jsdelivr.net" />

        <!-- External stylesheets -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
            crossorigin="anonymous"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
        />

        <!-- Application stylesheets -->
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}"
        />
        <link
            rel="icon"
            href="{{ url_for('static', filename='images/favicon.ico') }}"
        />

        <!-- Critical inline styles -->
        <style>
            .navbar {
                background-image:
                    linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                    url("{{ url_for('static', filename='images/blood-moon.jpeg') }}");
                background-position: center;
                background-repeat: no-repeat;
                background-size: cover;
                padding: 1rem 0;
            }
            .navbar-nav .nav-link {
                color: rgba(255, 255, 255, 0.8) !important;
            }
            .navbar-nav .nav-link:hover {
                color: white !important;
            }

            /* Skip link styling */
            .skip-link {
                position: absolute;
                top: -40px;
                left: 0;
                background: #000;
                color: white;
                padding: 8px;
                z-index: 9999;
            }
            .skip-link:focus {
                top: 0;
            }
        </style>

        <!-- Page-specific styles -->
        {% block styles %}{% endblock %}
    </head>

    <body class="d-flex flex-column min-vh-100">
        <!-- Accessibility skip link -->
        <a href="#main-content" class="skip-link visually-hidden-focusable"
            >Skip to main content</a
        >

        <!-- Header with navigation -->
        <header>
            <nav
                class="navbar navbar-expand-lg navbar-dark"
                aria-label="Main navigation"
            >
                <div class="container">
                    <a class="navbar-brand" href="{{ url_for('main.home') }}">
                        <i class="bi bi-cloud"></i> Cloud Service
                    </a>
                    <button
                        class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#navbarNav"
                        aria-label="Toggle navigation"
                        aria-expanded="false"
                        aria-controls="navbarNav"
                    >
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navbarNav">
                        <ul class="navbar-nav me-auto">
                            <li class="nav-item">
                                <a
                                    class="nav-link"
                                    href="{{ url_for('main.home') }}"
                                    >Home</a
                                >
                            </li>
                            <li class="nav-item">
                                <a
                                    class="nav-link"
                                    href="{{ url_for('main.cloud') }}"
                                    >Cloud Services</a
                                >
                            </li>
                            <li class="nav-item">
                                <a
                                    class="nav-link"
                                    href="{{ url_for('main.ics') }}"
                                    >ICS Application</a
                                >
                            </li>
                            <li class="nav-item">
                                <a
                                    class="nav-link"
                                    href="{{ url_for('main.about') }}"
                                    >About</a
                                >
                            </li>
                        </ul>
                        <ul class="navbar-nav">
                            {% if current_user.is_authenticated %}
                            <li class="nav-item dropdown">
                                <a
                                    class="nav-link dropdown-toggle"
                                    href="#"
                                    id="userDropdown"
                                    role="button"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                >
                                    <i class="bi bi-person-circle"></i> {{
                                    current_user.username }}
                                </a>
                                <ul
                                    class="dropdown-menu dropdown-menu-end"
                                    aria-labelledby="userDropdown"
                                >
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="{{ url_for('main.profile') }}"
                                            >Profile</a
                                        >
                                    </li>
                                    {% if current_user.is_admin %}
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="{{ url_for('main.admin') }}"
                                            >Admin Panel</a
                                        >
                                    </li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider" /></li>
                                    <li>
                                        <a
                                            class="dropdown-item"
                                            href="{{ url_for('auth.logout') }}"
                                            >Logout</a
                                        >
                                    </li>
                                </ul>
                            </li>
                            {% else %}
                            <li class="nav-item">
                                <a
                                    class="nav-link"
                                    href="{{ url_for('auth.login') }}"
                                    >Login</a
                                >
                            </li>
                            {% endif %}
                            <li class="nav-item">
                                <button
                                    class="btn nav-link"
                                    id="themeToggle"
                                    aria-label="Toggle theme"
                                >
                                    <i class="bi bi-moon-stars"></i>
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>

        <!-- Toast notifications -->
        <div
            class="toast-container position-fixed top-0 end-0 p-3"
            aria-live="polite"
            aria-atomic="true"
        >
            {% with messages = get_flashed_messages(with_categories=true) %} {%
            if messages %} {% for category, message in messages %}
            <div
                class="toast show"
                role="alert"
                aria-live="assertive"
                aria-atomic="true"
            >
                <div class="toast-header bg-{{ category }}">
                    <strong class="me-auto">Notification</strong>
                    <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="toast"
                        aria-label="Close"
                    ></button>
                </div>
                <div class="toast-body">{{ message }}</div>
            </div>
            {% endfor %} {% endif %} {% endwith %}
        </div>

        <!-- Main content area -->
        <main id="main-content" class="flex-grow-1">
            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        <footer class="footer mt-auto py-4 bg-light">
            <div class="container">
                <div class="row g-4">
                    <!-- Company Info -->
                    <div class="col-md-4">
                        <h5>Cloud Service</h5>
                        <p class="text-muted">
                            Secure and reliable cloud infrastructure for your
                            business needs.
                        </p>
                        <div class="social-links">
                            <a href="#" class="text-muted me-2"
                                ><i class="bi bi-linkedin"></i
                            ></a>
                            <a href="#" class="text-muted me-2"
                                ><i class="bi bi-twitter"></i
                            ></a>
                            <a href="#" class="text-muted"
                                ><i class="bi bi-github"></i
                            ></a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h5>Quick Links</h5>
                        <ul class="list-unstyled">
                            <li>
                                <a
                                    href="{{ url_for('main.about') }}"
                                    class="text-muted"
                                    >About</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{{ url_for('main.docs') }}"
                                    class="text-muted"
                                    >Documentation</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{{ url_for('main.pricing') }}"
                                    class="text-muted"
                                    >Pricing</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{{ url_for('main.contact') }}"
                                    class="text-muted"
                                    >Contact</a
                                >
                            </li>
                        </ul>
                    </div>
                    <!-- Newsletter Section -->
                    <div class="col-md-4">
                        <h5>Newsletter</h5>
                        <form
                            id="newsletter-form"
                            class="needs-validation"
                            novalidate
                        >
                            {{ csrf_token() }}
                            <div class="input-group mb-3">
                                <label
                                    for="newsletter-email"
                                    class="visually-hidden"
                                    >Email address</label
                                >
                                <input
                                    type="email"
                                    id="newsletter-email"
                                    class="form-control"
                                    placeholder="Enter email"
                                    required
                                    pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                                    aria-describedby="newsletterHelp"
                                />
                                <button class="btn btn-primary" type="submit">
                                    <span
                                        class="spinner-border spinner-border-sm d-none"
                                        role="status"
                                        aria-hidden="true"
                                    ></span>
                                    Subscribe
                                </button>
                                <div class="invalid-feedback">
                                    Please enter a valid email address.
                                </div>
                            </div>
                        </form>
                        <small id="newsletterHelp" class="text-muted">
                            Version {{ config.VERSION|default('1.0.0') }} |
                            <a
                                href="{{ url_for('main.privacy') }}"
                                class="text-muted"
                                >Privacy</a
                            >
                            |
                            <a
                                href="{{ url_for('main.terms') }}"
                                class="text-muted"
                                >Terms</a
                            >
                        </small>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Core scripts -->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"
        ></script>

        <!-- Common functionality -->
        <script>
            // Initialize Bootstrap components
            document.addEventListener("DOMContentLoaded", function () {
                // Initialize toasts with auto-dismiss
                const toastElems = document.querySelectorAll(".toast.show");
                toastElems.forEach((toast) => {
                    setTimeout(() => {
                        const bsToast = new bootstrap.Toast(toast);
                        bsToast.hide();
                    }, 5000);
                });

                // Theme toggle functionality
                const themeToggle = document.getElementById("themeToggle");
                if (themeToggle) {
                    themeToggle.addEventListener("click", () => {
                        const htmlElement = document.documentElement;
                        const currentTheme =
                            htmlElement.getAttribute("data-bs-theme");
                        const newTheme =
                            currentTheme === "dark" ? "light" : "dark";

                        htmlElement.setAttribute("data-bs-theme", newTheme);
                        localStorage.setItem("theme", newTheme);

                        // Update icon
                        const icon = themeToggle.querySelector("i");
                        if (icon) {
                            icon.classList.toggle("bi-moon-stars");
                            icon.classList.toggle("bi-sun");
                        }
                    });
                }
            });
        </script>

        <!-- Newsletter form handling -->
        <script>
            document
                .getElementById("newsletter-form")
                ?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const button = form.querySelector("button");
                    const spinner = button.querySelector(".spinner-border");

                    if (!form.checkValidity()) {
                        form.classList.add("was-validated");
                        return;
                    }

                    button.disabled = true;
                    spinner.classList.remove("d-none");

                    try {
                        const response = await fetch(
                            "/api/newsletter/subscribe",
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": "{{ csrf_token() }}",
                                },
                                body: JSON.stringify({
                                    email: form.querySelector(
                                        'input[type="email"]',
                                    ).value,
                                }),
                            },
                        );

                        if (response.ok) {
                            // Create success toast
                            const toastContainer =
                                document.querySelector(".toast-container");
                            const toastHtml = `
                    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="toast-header bg-success text-white">
                            <strong class="me-auto">Success</strong>
                            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                        </div>
                        <div class="toast-body">Successfully subscribed!</div>
                    </div>
                `;
                            toastContainer.insertAdjacentHTML(
                                "beforeend",
                                toastHtml,
                            );

                            // Auto-dismiss after 5 seconds
                            const newToast = toastContainer.lastElementChild;
                            setTimeout(() => {
                                const bsToast = new bootstrap.Toast(newToast);
                                bsToast.hide();
                            }, 5000);

                            form.reset();
                        } else {
                            throw new Error("Subscription failed");
                        }
                    } catch (error) {
                        // Create error toast
                        const toastContainer =
                            document.querySelector(".toast-container");
                        const toastHtml = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header bg-danger text-white">
                        <strong class="me-auto">Error</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">Failed to subscribe</div>
                </div>
            `;
                        toastContainer.insertAdjacentHTML(
                            "beforeend",
                            toastHtml,
                        );

                        // Auto-dismiss after 5 seconds
                        const newToast = toastContainer.lastElementChild;
                        setTimeout(() => {
                            const bsToast = new bootstrap.Toast(newToast);
                            bsToast.hide();
                        }, 5000);
                    } finally {
                        button.disabled = false;
                        spinner.classList.add("d-none");
                    }
                });
        </script>

        <!-- Page-specific scripts -->
        {% block scripts %}{% endblock %}
    </body>
</html>
