
<!DOCTYPE html>
<html lang="en" data-bs-theme="light" dir="ltr">
<head>
    <!-- 1. Character encoding (must be within the first 1024 bytes) -->
    <meta charset="UTF-8">
    <!-- 2. Viewport settings (critical for responsive design) -->
    <!-- Add responsive viewport settings -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 3. Compatibility and security headers -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Stronger Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self';
        script-src 'self' https://cdn.jsdelivr.net https://www.google.com;
        style-src 'self' https://cdn.jsdelivr.net; img-src 'self' data:;
        font-src 'self' https://cdn.jsdelivr.net; connect-src 'self'">
    <!-- Add Permissions Policy -->
    <meta http-equiv="Permissions-Policy" content="geolocation=(), camera=(), microphone=()">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- 4. Primary meta information -->
    <meta name="theme-color" content="#0066cc">
    <meta name="description" content="Cloud infrastructure management platform">

    <!-- 7. Title (browsers often look for this early) -->
    <title>{% block title %}Cloud Service{% endblock %}</title>

    <!-- 5. Preconnect to external domains -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">

    <!-- 6. Preload critical resources -->
    <!-- Preload critical resources -->
    <link rel="preload" href="{{ url_for('static', filename='images/blood-moon.jpeg') }}" as="image">

    <!-- 9. External stylesheets -->
    <!-- Styles -->
    <!-- Implement SRI for external resources -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous">
    <!-- 10. Application-specific CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- 11. Favicon (low priority) -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">

    <!-- 8. Critical CSS before external stylesheets -->
    <!-- Critical inline styles -->
    <style>
        /* Critical CSS for above-the-fold content */
        .navbar {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                            url("{{ url_for('static', filename='images/blood-moon.jpeg') }}");
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;
            padding: 1rem 0;
        }
        .navbar-nav .nav-link {
            color: rgba(255,255,255,.8) !important;
        }
        .navbar-nav .nav-link:hover {
            color: white !important;
        }
    </style>


    <!-- 12. Additional block for page-specific styles -->
    <!-- Page-specific styles -->
    {% block styles %}{% endblock %}
</head>

<body class="d-flex flex-column min-vh-100">
    <!-- 1. Accessibility skip link -->
    <a href="#main-content" class="visually-hidden-focusable skip-link">Skip to main content</a>

    <!-- 2. Header with navigation -->
    <header>
        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container">
                <!-- Logo/Brand -->
                <a class="navbar-brand" href="{{ url_for('main.home') }}">
                    <i class="bi bi-cloud"></i> Cloud Service
                </a>

                <!-- Mobile navigation toggle -->
                <button class="navbar-toggler"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#navbarNav"
                        aria-label="Toggle navigation"
                        aria-expanded="false"
                        aria-controls="navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Navigation content -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <!-- Main navigation -->
                    <ul class="navbar-nav me-auto">
                        {% set navigation_items = [ ('main.home', 'Home'),
                        ('main.cloud', 'Cloud Services'), ('main.ics', 'ICS
                        Application'), ('main.about', 'About') ] %}
                        {% for endpoint, text in navigation_items %}
                            <li class="nav-item">
                                <a class="nav-link {% if request.endpoint == endpoint %}active{% endif %}"
                                    href="{{ url_for(endpoint) }}"
                                    {% if request.endpoint == endpoint %}
                                        aria-current="page"
                                    {% endif %}
                                >
                                    {{ text }}
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </nav>
        </header>

        <!-- 3. Flash messages container -->
        <!-- Improved toast handling for flash messages -->
        <div class="toast-container position-fixed top-0 end-0 p-3" aria-live="polite" aria-atomic="true">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="toast-header bg-{{ category }}">
                                <strong class="me-auto">Notification</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">{{ message }}</div>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <!-- 4. Main content area -->
        <main id="main-content" class="flex-grow-1">
            {% block content %}{% endblock %}
        </main>

        <!-- 5. Footer -->
        <!-- Enhance responsive footer -->
        <footer class="footer mt-auto py-4 bg-light">
            <div class="container">
                <!-- Will stack on mobile, 3 columns on medium screens and up -->
                <div class="row g-4 row-cols-1 row-cols-md-3">
                    <!-- Company Info -->
                    <div class="col-md-4">
                        <h5>Cloud Service</h5>
                        <p class="text-muted">
                            Secure and reliable cloud infrastructure for your
                            business needs.
                        </p>
                        <div class="social-links">
                            <a href="#" class="text-muted me-2"
                                ><i class="bi bi-linkedin"></i
                            ></a>
                            <a href="#" class="text-muted me-2"
                                ><i class="bi bi-twitter"></i
                            ></a>
                            <a href="#" class="text-muted"
                                ><i class="bi bi-github"></i
                            ></a>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h5>Quick Links</h5>
                        <ul class="list-unstyled">
                            <li>
                                <a
                                    href="{{ url_for('main.about') }}"
                                    class="text-muted"
                                    >About</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{{ url_for('main.docs') }}"
                                    class="text-muted"
                                    >Documentation</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{{ url_for('main.pricing') }}"
                                    class="text-muted"
                                    >Pricing</a
                                >
                            </li>
                            <li>
                                <a
                                    href="{{ url_for('main.contact') }}"
                                    class="text-muted"
                                    >Contact</a
                                >
                            </li>
                        </ul>
                    </div>

                    <!-- Newsletter Section -->
                    <div class="col-md-4">
                        <h5>Newsletter</h5>
                        <form
                            id="newsletter-form"
                            class="needs-validation"
                            novalidate
                        >
                            {{ csrf_token() }}

                            <!-- Improve form accessibility -->
                            <div class="input-group mb-3">
                                <label
                                    for="newsletter-email"
                                    class="visually-hidden"
                                    >Email address</label
                                >
                                <input
                                    type="email"
                                    id="newsletter-email"
                                    class="form-control"
                                    placeholder="Enter email"
                                    required
                                    pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                                    aria-describedby="newsletterHelp"
                                />
                                />
                                <button class="btn btn-primary" type="submit">
                                    <span
                                        class="spinner-border spinner-border-sm d-none"
                                        role="status"
                                    ></span>
                                    Subscribe
                                </button>
                                <div class="invalid-feedback">
                                    Please enter a valid email address.
                                </div>
                            </div>
                        </form>
                        <small id="newsletterHelp" class="text-muted">
                            Version {{ config.VERSION|default('1.0.0') }} |
                            <a
                                href="{{ url_for('main.privacy') }}"
                                class="text-muted"
                                >Privacy</a
                            >
                            |
                            <a
                                href="{{ url_for('main.terms') }}"
                                class="text-muted"
                                >Terms</a
                            >
                        </small>
                    </div>
                </div>
            </div>
        </footer>

        <!-- 6. Essential scripts (loaded last for performance) -->
        <!-- Core scripts -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous">
        </script>

        <!-- Toast initialization -->
        <script>
        // Auto-dismiss toasts after 5 seconds
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize all toasts
            const toastElems = document.querySelectorAll('.toast.show');
            toastElems.forEach(toast => {
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    const bsToast = new bootstrap.Toast(toast);
                    bsToast.hide();
                }, 5000);
            });
        });
        </script>

        <!-- 7. Page-specific scripts -->
        <!-- Script loading at end of body -->
        {% block scripts %}
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const newsletterForm = document.getElementById('newsletter-form');

            newsletterForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const emailInput = this.querySelector('input[type="email"]');
                const button = this.querySelector('button[type="submit"]');
                const spinner = button.querySelector('.spinner-border');

                // Perform client-side validation
                if (!newsletterForm.checkValidity()) {
                    newsletterForm.classList.add('was-validated');
                    return;
                }

                try {
                    // Disable button and show spinner
                    button.disabled = true;
                    spinner.classList.remove('d-none');

                    // Add CSRF token to headers
                    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

                    // Send the request
                    const response = await fetch('/api/newsletter/subscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken || ''
                        },
                        body: JSON.stringify({
                            email: emailInput.value
                        })
                    });

                    if (response.ok) {
                        // Show success message
                        const toastContainer = document.querySelector('.toast-container');
                        const toastHtml = `
                            <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                                <div class="toast-header bg-success text-white">
                                    <strong class="me-auto">Success</strong>
                                    <small>Just now</small>
                                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                                </div>
                                <div class="toast-body">Successfully subscribed to newsletter!</div>
                            </div>
                        `;
                        toastContainer.insertAdjacentHTML('beforeend', toastHtml);

                        // Auto-dismiss after 5 seconds
                        const newToast = toastContainer.lastElementChild;
                        setTimeout(() => {
                            const bsToast = new bootstrap.Toast(newToast);
                            bsToast.hide();
                        }, 5000);

                        // Reset the form
                        newsletterForm.reset();
                        newsletterForm.classList.remove('was-validated');
                    } else {
                        throw new Error('Subscription failed');
                    }
                } catch (error) {
                    console.error('Newsletter subscription error:', error);

                    // Show error message
                    const toastContainer = document.querySelector('.toast-container');
                    const toastHtml = `
                        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
                            <div class="toast-header bg-danger text-white">
                                <strong class="me-auto">Error</strong>
                                <small>Just now</small>
                                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                            </div>
                            <div class="toast-body">Failed to subscribe. Please try again later.</div>
                        </div>
                    `;
                    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

                    // Auto-dismiss after 5 seconds
                    const newToast = toastContainer.lastElementChild;
                    setTimeout(() => {
                        const bsToast = new bootstrap.Toast(newToast);
                        bsToast.hide();
                    }, 5000);
                } finally {
                    // Re-enable button and hide spinner
                    button.disabled = false;
                    spinner.classList.add('d-none');
                }
            });
        });
        </script>
        {% endblock %}

        <!-- 8. Deferred non-critical scripts -->
        <!-- Defer non-critical JavaScript -->
        <!-- Improved theme toggling with localStorage persistence -->
        <script defer>
            document.addEventListener("DOMContentLoaded", function () {
                const themeToggle = document.getElementById("themeToggle");
                const htmlElement = document.documentElement;

                // Check for saved theme preference or use OS preference
                const savedTheme =
                    localStorage.getItem("theme") ||
                    (window.matchMedia("(prefers-color-scheme: dark)").matches
                        ? "dark"
                        : "light");

                // Apply the theme
                applyTheme(savedTheme);

                // Handle theme toggle click
                themeToggle.addEventListener("click", function () {
                    const currentTheme =
                        htmlElement.getAttribute("data-bs-theme");
                    const newTheme = currentTheme === "dark" ? "light" : "dark";

                    applyTheme(newTheme);
                    localStorage.setItem("theme", newTheme);
                });

                function applyTheme(theme) {
                    htmlElement.setAttribute("data-bs-theme", theme);
                    themeToggle.innerHTML =
                        theme === "dark"
                            ? '<i class="bi bi-sun-fill"></i>'
                            : '<i class="bi bi-moon-stars-fill"></i>';
                    themeToggle.setAttribute(
                        "aria-label",
                        theme === "dark"
                            ? "Switch to light theme"
                            : "Switch to dark theme",
                    );
                }
            });
        </script>
    </body>
</html>
