{% extends "admin/layout.html" %}

{% block title %}Compliance Reports{% endblock %}
{% block page_title %}Compliance Reporting{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item">
    <a href="{{ url_for('admin.dashboard') }}">Dashboard</a>
</li>
<li class="breadcrumb-item">
    <a href="#">Reports</a>
</li>
<li class="breadcrumb-item active" aria-current="page">Compliance</li>
{% endblock %}

{% block page_actions %}
<div class="btn-group" role="group">
    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal"
        data-bs-target="#generateReportModal">
        <i class="bi bi-plus-circle me-1"></i> Generate Report
    </button>
    <button class="btn btn-sm btn-outline-secondary" type="button" id="refreshReports">
        <i class="bi bi-arrow-clockwise me-1"></i> Refresh
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Compliance Overview -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light">
        <h5 class="card-title mb-0">Compliance Overview</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card h-100 bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-2">Overall Compliance</h6>
                        <div class="display-6 mb-2">
                            {% set compliance_percentage = compliance_metrics.overall_compliance|default(0) %}
                            <span
                                class="text-{{ 'success' if compliance_percentage >= 80 else 'warning' if compliance_percentage >= 60 else 'danger' }}">
                                {{ compliance_percentage }}%
                            </span>
                        </div>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar bg-{{ 'success' if compliance_percentage >= 80 else 'warning' if compliance_percentage >= 60 else 'danger' }}"
                                role="progressbar" style="width: {{ compliance_percentage }}%;"
                                aria-valuenow="{{ compliance_percentage }}" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card h-100 bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-2">Control Implementation</h6>
                        <div class="mb-2">
                            <span class="badge bg-success me-1">{{ compliance_metrics.controls_implemented|default(0)
                                }}</span>
                            <span class="text-muted">of</span>
                            <span class="badge bg-secondary ms-1">{{ compliance_metrics.total_controls|default(0)
                                }}</span>
                        </div>
                        <small class="text-muted">Controls implemented</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card h-100 bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-2">Critical Gaps</h6>
                        <div class="display-6 mb-2">{{ compliance_metrics.critical_gaps|default(0) }}</div>
                        <span
                            class="badge bg-{{ 'danger' if compliance_metrics.critical_gaps|default(0) > 0 else 'success' }}">
                            {{ 'Action Required' if compliance_metrics.critical_gaps|default(0) > 0 else 'None Detected'
                            }}
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-lg-3 mb-3">
                <div class="card h-100 bg-light">
                    <div class="card-body text-center">
                        <h6 class="card-title mb-2">Last Assessment</h6>
                        <div class="mb-2">{{ compliance_metrics.last_assessment|default('Never')|datetime }}</div>
                        <small class="text-muted">
                            {{ compliance_metrics.assessment_status|default('No assessments yet') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-md-12">
                <h6>Frameworks</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 30%">Framework</th>
                                <th style="width: 20%">Compliance Level</th>
                                <th style="width: 15%">Controls</th>
                                <th style="width: 15%">Gaps</th>
                                <th style="width: 20%">Last Updated</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if compliance_frameworks %}
                            {% for framework in compliance_frameworks %}
                            <tr>
                                <td>
                                    <strong>{{ framework.name }}</strong>
                                    <div class="small text-muted">{{ framework.version }}</div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 5px;">
                                            <div class="progress-bar bg-{{ 'success' if framework.compliance_percentage >= 80 else 'warning' if framework.compliance_percentage >= 60 else 'danger' }}"
                                                role="progressbar"
                                                style="width: {{ framework.compliance_percentage }}%;"
                                                aria-valuenow="{{ framework.compliance_percentage }}" aria-valuemin="0"
                                                aria-valuemax="100"></div>
                                        </div>
                                        <span class="ms-2">{{ framework.compliance_percentage }}%</span>
                                    </div>
                                </td>
                                <td>
                                    {{ framework.implemented_controls }} / {{ framework.total_controls }}
                                </td>
                                <td>
                                    <span
                                        class="badge rounded-pill bg-{{ 'danger' if framework.critical_gaps > 0 else 'success' }}">
                                        {{ framework.critical_gaps }} critical
                                    </span>
                                    <div class="small text-muted">{{ framework.total_gaps }} total</div>
                                </td>
                                <td>{{ framework.last_updated|datetime }}</td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-3">No compliance frameworks configured</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Reports -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Recent Compliance Reports</h5>
        <span class="badge bg-secondary">{{ reports.total|default(0) }} Reports</span>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col">Report Name</th>
                    <th scope="col">Type</th>
                    <th scope="col">Period</th>
                    <th scope="col">Created</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if reports and reports.items %}
                {% for report in reports.items %}
                <tr>
                    <td>{{ report.name }}</td>
                    <td>
                        <span class="badge text-bg-light">{{ report.report_type }}</span>
                    </td>
                    <td class="text-nowrap">
                        {{ report.period_start.strftime('%Y-%m-%d') }} to {{ report.period_end.strftime('%Y-%m-%d') }}
                    </td>
                    <td class="text-nowrap">{{ report.created_at|datetime }}</td>
                    <td>
                        <span class="badge rounded-pill
                            {% if report.status == 'completed' %}bg-success
                            {% elif report.status == 'generating' %}bg-info
                            {% elif report.status == 'failed' %}bg-danger
                            {% elif report.status == 'scheduled' %}bg-warning
                            {% else %}bg-secondary{% endif %}">
                            {{ report.status|capitalize }}
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            {% if report.is_available %}
                            <a href="{{ url_for('admin.download_compliance_report', report_id=report.id) }}"
                                class="btn btn-outline-primary" title="Download Report">
                                <i class="bi bi-download"></i>
                            </a>
                            {% endif %}
                            <button type="button" class="btn btn-outline-secondary view-report-details"
                                data-report-id="{{ report.id }}" data-bs-toggle="modal"
                                data-bs-target="#reportDetailsModal">
                                <i class="bi bi-info-circle"></i>
                            </button>
                            {% if report.status != 'generating' %}
                            <button type="button" class="btn btn-outline-danger delete-report-btn"
                                data-report-id="{{ report.id }}" title="Delete Report">
                                <i class="bi bi-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-3">
                        <i class="bi bi-clipboard-data fs-2 text-muted d-block mb-2"></i>
                        <p class="mb-0">No compliance reports have been generated yet.</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="card-footer bg-white d-flex justify-content-between align-items-center">
        <div class="text-muted small">
            Showing {{ reports.items|length if reports else 0 }} of {{ reports.total if reports else 0 }} reports
            {% if reports and reports.total > 0 %}
            (Page {{ reports.page }} of {{ reports.pages }})
            {% endif %}
        </div>

        {% if reports and reports.pages > 1 %}
        <nav aria-label="Report pagination">
            <ul class="pagination mb-0">
                <!-- First Page -->
                <li class="page-item {{ 'disabled' if reports.page == 1 else '' }}">
                    <a class="page-link" href="{{ url_for('admin.compliance_reports', page=1, **request.args) }}"
                        aria-label="First">
                        <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                </li>

                <!-- Previous Page -->
                <li class="page-item {{ 'disabled' if not reports.has_prev else '' }}">
                    <a class="page-link"
                        href="{{ url_for('admin.compliance_reports', page=reports.prev_num, **request.args) if reports.has_prev else '#' }}"
                        aria-label="Previous">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>

                <!-- Page Numbers -->
                {% for page_num in reports.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                {% if page_num %}
                <li class="page-item {{ 'active' if page_num == reports.page else '' }}">
                    <a class="page-link"
                        href="{{ url_for('admin.compliance_reports', page=page_num, **request.args) }}">
                        {{ page_num }}
                    </a>
                </li>
                {% else %}
                <li class="page-item disabled">
                    <span class="page-link">â€¦</span>
                </li>
                {% endif %}
                {% endfor %}

                <!-- Next Page -->
                <li class="page-item {{ 'disabled' if not reports.has_next else '' }}">
                    <a class="page-link"
                        href="{{ url_for('admin.compliance_reports', page=reports.next_num, **request.args) if reports.has_next else '#' }}"
                        aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>

                <!-- Last Page -->
                <li class="page-item {{ 'disabled' if reports.page == reports.pages else '' }}">
                    <a class="page-link"
                        href="{{ url_for('admin.compliance_reports', page=reports.pages, **request.args) }}"
                        aria-label="Last">
                        <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- Scheduled Reports -->
<div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Scheduled Reports</h5>
        <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal"
            data-bs-target="#scheduleReportModal">
            <i class="bi bi-calendar-plus me-1"></i> Schedule Report
        </button>
    </div>
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col">Type</th>
                    <th scope="col">Frequency</th>
                    <th scope="col">Last Run</th>
                    <th scope="col">Next Run</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% if scheduled_reports %}
                {% for report in scheduled_reports %}
                <tr>
                    <td>{{ report.name }}</td>
                    <td>
                        <span class="badge text-bg-light">{{ report.report_type }}</span>
                    </td>
                    <td>{{ report.schedule_frequency|capitalize }}</td>
                    <td class="text-nowrap">{{ report.last_generated_at|datetime|default('Never') }}</td>
                    <td class="text-nowrap">{{ report.next_run_at|datetime }}</td>
                    <td>
                        <span class="badge rounded-pill
                            {% if report.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                            {{ 'Active' if report.is_active else 'Inactive' }}
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary edit-schedule-btn"
                                data-schedule-id="{{ report.id }}" title="Edit Schedule">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary run-now-btn"
                                data-schedule-id="{{ report.id }}" title="Run Now">
                                <i class="bi bi-play-fill"></i>
                            </button>
                            <button type="button" class="btn btn-outline-danger delete-schedule-btn"
                                data-schedule-id="{{ report.id }}" title="Delete Schedule">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
                {% else %}
                <tr>
                    <td colspan="7" class="text-center py-3">
                        <i class="bi bi-calendar fs-2 text-muted d-block mb-2"></i>
                        <p class="mb-0">No scheduled compliance reports configured.</p>
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Generate Report Modal -->
<div class="modal fade" id="generateReportModal" tabindex="-1" aria-labelledby="generateReportModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateReportModalLabel">Generate Compliance Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('admin.compliance_reports') }}" id="generateReportForm">
                <div class="modal-body">
                    {{ form.csrf_token }}
                    <div class="alert alert-info d-flex align-items-center">
                        <i class="bi bi-info-circle-fill flex-shrink-0 me-2"></i>
                        <div>
                            Report generation may take several minutes depending on the scope and timeframe selected.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="name" class="form-label">Report Name</label>
                        <input type="text" class="form-control" id="name" name="name"
                            placeholder="E.g. Q2 2023 PCI-DSS Compliance Report" required>
                    </div>

                    <div class="mb-3">
                        <label for="report_type" class="form-label">Report Type</label>
                        <select class="form-select" id="report_type" name="report_type" required>
                            <option value="" selected disabled>Select report type</option>
                            <option value="pci-dss">PCI-DSS</option>
                            <option value="hipaa">HIPAA</option>
                            <option value="gdpr">GDPR</option>
                            <option value="soc2">SOC 2</option>
                            <option value="iso27001">ISO 27001</option>
                            <option value="nist">NIST 800-53</option>
                            <option value="custom">Custom Assessment</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="period_start" class="form-label">Period Start</label>
                            <input type="date" class="form-control" id="period_start" name="period_start" required>
                        </div>
                        <div class="col-md-6">
                            <label for="period_end" class="form-label">Period End</label>
                            <input type="date" class="form-control" id="period_end" name="period_end" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="format" class="form-label">Report Format</label>
                        <select class="form-select" id="format" name="format" required>
                            <option value="pdf" selected>PDF Document</option>
                            <option value="html">HTML Document</option>
                            <option value="json">JSON Data</option>
                            <option value="csv">CSV Data</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="include_evidence" class="form-check-label">Include Evidence</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="include_evidence"
                                name="include_evidence" checked>
                            <label class="form-check-label" for="include_evidence">Attach evidence files to the
                                report</label>
                        </div>
                        <div class="form-text">Including evidence may increase report generation time and file size.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"
                            placeholder="Additional context or information about this report"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="generateBtn">
                        <span class="spinner-border spinner-border-sm d-none me-1" role="status"
                            aria-hidden="true"></span>
                        <i class="bi bi-file-earmark-check me-1"></i> Generate Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Schedule Report Modal -->
<div class="modal fade" id="scheduleReportModal" tabindex="-1" aria-labelledby="scheduleReportModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleReportModalLabel">Schedule Recurring Report</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{{ url_for('admin.schedule_compliance_report') }}" id="scheduleReportForm">
                <div class="modal-body">
                    {{ form.csrf_token }}
                    <div class="mb-3">
                        <label for="schedule_name" class="form-label">Schedule Name</label>
                        <input type="text" class="form-control" id="schedule_name" name="schedule_name"
                            placeholder="E.g. Monthly PCI-DSS Report" required>
                    </div>

                    <div class="mb-3">
                        <label for="schedule_report_type" class="form-label">Report Type</label>
                        <select class="form-select" id="schedule_report_type" name="schedule_report_type" required>
                            <option value="" selected disabled>Select report type</option>
                            <option value="pci-dss">PCI-DSS</option>
                            <option value="hipaa">HIPAA</option>
                            <option value="gdpr">GDPR</option>
                            <option value="soc2">SOC 2</option>
                            <option value="iso27001">ISO 27001</option>
                            <option value="nist">NIST 800-53</option>
                            <option value="custom">Custom Assessment</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="schedule_frequency" class="form-label">Frequency</label>
                        <select class="form-select" id="schedule_frequency" name="schedule_frequency" required>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                            <option value="quarterly">Quarterly</option>
                        </select>
                    </div>

                    <div class="mb-3" id="weekdaySelectContainer" style="display: none;">
                        <label for="schedule_weekday" class="form-label">Day of Week</label>
                        <select class="form-select" id="schedule_weekday" name="schedule_weekday">
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>

                    <div class="mb-3" id="monthlyDaySelectContainer">
                        <label for="schedule_day" class="form-label">Day of Month</label>
                        <select class="form-select" id="schedule_day" name="schedule_day">
                            {% for day in range(1, 29) %}
                            <option value="{{ day }}" {{ 'selected' if day==1 else '' }}>{{ day }}</option>
                            {% endfor %}
                            <option value="last">Last day</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="schedule_format" class="form-label">Report Format</label>
                        <select class="form-select" id="schedule_format" name="schedule_format" required>
                            <option value="pdf" selected>PDF Document</option>
                            <option value="html">HTML Document</option>
                            <option value="json">JSON Data</option>
                            <option value="csv">CSV Data</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="schedule_active" name="schedule_active"
                                checked>
                            <label class="form-check-label" for="schedule_active">Active</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="schedule_notification"
                                name="schedule_notification" checked>
                            <label class="form-check-label" for="schedule_notification">Send email notification</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="scheduleBtn">
                        <i class="bi bi-calendar-check me-1"></i> Schedule Report
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Report Details Modal -->
<div class="modal fade" id="reportDetailsModal" tabindex="-1" aria-labelledby="reportDetailsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportDetailsModalLabel">Report Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Report Name:</strong> <span id="detail-name"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Report Type:</strong> <span id="detail-type"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Created Date:</strong> <span id="detail-created"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Completed Date:</strong> <span id="detail-completed"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Period:</strong> <span id="detail-period"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Format:</strong> <span id="detail-format"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <strong>Status:</strong> <span id="detail-status"></span>
                    </div>
                    <div class="col-md-6">
                        <strong>Download Count:</strong> <span id="detail-downloads"></span>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <strong>Notes:</strong>
                        <p id="detail-notes" class="mb-0"></p>
                    </div>
                </div>

                <div class="mt-3" id="error-container" style="display: none;">
                    <h6 class="text-danger">Error Information</h6>
                    <div class="alert alert-danger">
                        <p id="detail-error" class="mb-0"></p>
                    </div>
                </div>

                <div class="mt-3" id="summary-container" style="display: none;">
                    <h6>Report Summary</h6>
                    <div class="table-responsive">
                        <table class="table table-sm table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>Category</th>
                                    <th>Total</th>
                                    <th>Passed</th>
                                    <th>Failed</th>
                                    <th>Compliance</th>
                                </tr>
                            </thead>
                            <tbody id="summary-table-body">
                                <!-- Dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#" id="detail-download-link" class="btn btn-primary" style="display: none;">
                    <i class="bi bi-download me-1"></i> Download Report
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Report Confirmation Modal -->
<div class="modal fade" id="deleteReportModal" tabindex="-1" aria-labelledby="deleteReportModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteReportModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
                    <div>
                        Are you sure you want to delete this report? This action cannot be undone.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{{ url_for('admin.delete_compliance_report') }}" id="deleteReportForm">
                    {{ form.csrf_token }}
                    <input type="hidden" name="report_id" id="delete_report_id">
                    <button type="submit" class="btn btn-danger">Delete Report</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Schedule Confirmation Modal -->
<div class="modal fade" id="deleteScheduleModal" tabindex="-1" aria-labelledby="deleteScheduleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteScheduleModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill flex-shrink-0 me-2"></i>
                    <div>
                        Are you sure you want to delete this scheduled report? This action cannot be undone.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" action="{{ url_for('admin.delete_compliance_schedule') }}" id="deleteScheduleForm">
                    {{ form.csrf_token }}
                    <input type="hidden" name="schedule_id" id="delete_schedule_id">
                    <button type="submit" class="btn btn-danger">Delete Schedule</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script nonce="{{ csp_nonce }}">
    document.addEventListener('DOMContentLoaded', function () {
        // Set default dates for report generation form
        const today = new Date();
        const firstDayPrevMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastDayPrevMonth = new Date(today.getFullYear(), today.getMonth(), 0);

        document.getElementById('period_start').valueAsDate = firstDayPrevMonth;
        document.getElementById('period_end').valueAsDate = lastDayPrevMonth;

        // Refresh button
        document.getElementById('refreshReports').addEventListener('click', function () {
            showLoading();
            window.location.reload();
        });

        // Handle frequency change in schedule form
        document.getElementById('schedule_frequency').addEventListener('change', function () {
            const weekdayContainer = document.getElementById('weekdaySelectContainer');
            const monthlyContainer = document.getElementById('monthlyDaySelectContainer');

            switch (this.value) {
                case 'daily':
                    weekdayContainer.style.display = 'none';
                    monthlyContainer.style.display = 'none';
                    break;
                case 'weekly':
                    weekdayContainer.style.display = 'block';
                    monthlyContainer.style.display = 'none';
                    break;
                case 'monthly':
                case 'quarterly':
                    weekdayContainer.style.display = 'none';
                    monthlyContainer.style.display = 'block';
                    break;
            }
        });

        // Generate report form submission
        const generateReportForm = document.getElementById('generateReportForm');
        if (generateReportForm) {
            generateReportForm.addEventListener('submit', function (e) {
                const startDate = new Date(document.getElementById('period_start').value);
                const endDate = new Date(document.getElementById('period_end').value);

                // Validate dates
                if (startDate > endDate) {
                    e.preventDefault();
                    showToast('Validation Error', 'Start date cannot be after end date', 'warning');
                    return false;
                }

                // Show loading indicator
                const generateBtn = document.getElementById('generateBtn');
                const spinner = generateBtn.querySelector('.spinner-border');
                spinner.classList.remove('d-none');
                generateBtn.disabled = true;
                showLoading();
            });
        }

        // View report details
        document.querySelectorAll('.view-report-details').forEach(btn => {
            btn.addEventListener('click', async function () {
                const reportId = this.getAttribute('data-report-id');
                try {
                    showLoading();
                    const response = await secureFetch(`/api/compliance/reports/${reportId}`);
                    hideLoading();

                    if (!response.ok) throw new Error('Failed to fetch report details');

                    const report = await response.json();

                    // Populate modal with report data
                    document.getElementById('detail-name').textContent = report.name;
                    document.getElementById('detail-type').textContent = report.report_type;
                    document.getElementById('detail-created').textContent = new Date(report.created_at).toLocaleString();
                    document.getElementById('detail-completed').textContent = report.completed_at ?
                        new Date(report.completed_at).toLocaleString() : 'Not completed';
                    document.getElementById('detail-period').textContent =
                        `${new Date(report.period_start).toLocaleDateString()} to ${new Date(report.period_end).toLocaleDateString()}`;
                    document.getElementById('detail-format').textContent = report.format.toUpperCase();

                    // Format status with badge
                    let statusClass = '';
                    switch (report.status) {
                        case 'completed': statusClass = 'text-bg-success'; break;
                        case 'generating': statusClass = 'text-bg-info'; break;
                        case 'failed': statusClass = 'text-bg-danger'; break;
                        default: statusClass = 'text-bg-secondary';
                    }
                    document.getElementById('detail-status').innerHTML =
                        `<span class="badge ${statusClass}">${report.status.charAt(0).toUpperCase() + report.status.slice(1)}</span>`;

                    document.getElementById('detail-downloads').textContent = report.download_count;
                    document.getElementById('detail-notes').textContent = report.notes || 'No notes provided';

                    // Handle errors if present
                    const errorContainer = document.getElementById('error-container');
                    if (report.status === 'failed' && report.completion_notes) {
                        errorContainer.style.display = 'block';
                        document.getElementById('detail-error').textContent = report.completion_notes;
                    } else {
                        errorContainer.style.display = 'none';
                    }

                    // Handle report summary if available
                    const summaryContainer = document.getElementById('summary-container');
                    if (report.status === 'completed' && report.metadata && report.metadata.summary) {
                        summaryContainer.style.display = 'block';
                        const summaryBody = document.getElementById('summary-table-body');
                        summaryBody.innerHTML = '';

                        // Add summary rows
                        for (const category in report.metadata.summary) {
                            const data = report.metadata.summary[category];
                            const row = document.createElement('tr');
                            const compliancePercentage = Math.round((data.passed / data.total) * 100);

                            row.innerHTML = `
                                <td>${category}</td>
                                <td>${data.total}</td>
                                <td>${data.passed}</td>
                                <td>${data.failed}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress flex-grow-1" style="height: 5px;">
                                            <div class="progress-bar bg-${compliancePercentage >= 80 ? 'success' : compliancePercentage >= 60 ? 'warning' : 'danger'}"
                                                role="progressbar" style="width: ${compliancePercentage}%;"
                                                aria-valuenow="${compliancePercentage}" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        <span class="ms-2">${compliancePercentage}%</span>
                                    </div>
                                </td>
                            `;
                            summaryBody.appendChild(row);
                        }
                    } else {
                        summaryContainer.style.display = 'none';
                    }

                    // Show/hide download link
                    const downloadLink = document.getElementById('detail-download-link');
                    if (report.is_available) {
                        downloadLink.style.display = 'inline-block';
                        downloadLink.href = `/admin/reports/compliance/${reportId}/download`;
                    } else {
                        downloadLink.style.display = 'none';
                    }
                } catch (error) {
                    console.error('Error fetching report details:', error);
                    hideLoading();
                    showToast('Error', 'Failed to load report details', 'danger');
                }
            });
        });

        // Handle delete report buttons
        document.querySelectorAll('.delete-report-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const reportId = this.getAttribute('data-report-id');
                document.getElementById('delete_report_id').value = reportId;

                const modal = new bootstrap.Modal(document.getElementById('deleteReportModal'));
                modal.show();
            });
        });

        // Handle delete schedule buttons
        document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const scheduleId = this.getAttribute('data-schedule-id');
                document.getElementById('delete_schedule_id').value = scheduleId;

                const modal = new bootstrap.Modal(document.getElementById('deleteScheduleModal'));
                modal.show();
            });
        });

        // Run now button handler
        document.querySelectorAll('.run-now-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const scheduleId = this.getAttribute('data-schedule-id');
                try {
                    showLoading();
                    const response = await secureFetch(`/api/compliance/schedules/${scheduleId}/run`, {
                        method: 'POST'
                    });
                    hideLoading();

                    if (response.ok) {
                        showToast('Success', 'Report generation has been started', 'success');
                        setTimeout(() => window.location.reload(), 2000);
                    } else {
                        const data = await response.json();
                        showToast('Error', data.message || 'Failed to run report', 'danger');
                    }
                } catch (error) {
                    console.error('Error running report:', error);
                    hideLoading();
                    showToast('Error', 'An unexpected error occurred', 'danger');
                }
            });
        });

        // Edit schedule button handler
        document.querySelectorAll('.edit-schedule-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const scheduleId = this.getAttribute('data-schedule-id');
                try {
                    showLoading();
                    const response = await secureFetch(`/api/compliance/schedules/${scheduleId}`);
                    hideLoading();

                    if (response.ok) {
                        const schedule = await response.json();

                        // Populate form with schedule data
                        document.getElementById('schedule_name').value = schedule.name;
                        document.getElementById('schedule_report_type').value = schedule.report_type;
                        document.getElementById('schedule_frequency').value = schedule.schedule_frequency;
                        document.getElementById('schedule_format').value = schedule.format;
                        document.getElementById('schedule_active').checked = schedule.is_active;
                        document.getElementById('schedule_notification').checked = schedule.send_notification;

                        // Set appropriate day options based on frequency
                        if (schedule.schedule_frequency === 'weekly' && schedule.schedule_params.weekday !== undefined) {
                            document.getElementById('weekdaySelectContainer').style.display = 'block';
                            document.getElementById('monthlyDaySelectContainer').style.display = 'none';
                            document.getElementById('schedule_weekday').value = schedule.schedule_params.weekday;
                        } else if (['monthly', 'quarterly'].includes(schedule.schedule_frequency) &&
                            schedule.schedule_params.day !== undefined) {
                            document.getElementById('weekdaySelectContainer').style.display = 'none';
                            document.getElementById('monthlyDaySelectContainer').style.display = 'block';
                            document.getElementById('schedule_day').value = schedule.schedule_params.day;
                        } else {
                            document.getElementById('weekdaySelectContainer').style.display = 'none';
                            document.getElementById('monthlyDaySelectContainer').style.display = 'none';
                        }

                        // Update form action to update endpoint
                        const form = document.getElementById('scheduleReportForm');
                        form.action = `/admin/reports/compliance/schedules/${scheduleId}/update`;

                        // Update modal title and button
                        document.getElementById('scheduleReportModalLabel').textContent = 'Edit Scheduled Report';
                        document.getElementById('scheduleBtn').innerHTML = '<i class="bi bi-save me-1"></i> Update Schedule';

                        // Show modal
                        const modal = new bootstrap.Modal(document.getElementById('scheduleReportModal'));
                        modal.show();
                    } else {
                        const data = await response.json();
                        showToast('Error', data.message || 'Failed to load schedule details', 'danger');
                    }
                } catch (error) {
                    console.error('Error fetching schedule details:', error);
                    hideLoading();
                    showToast('Error', 'An unexpected error occurred', 'danger');
                }
            });
        });

        const scheduleModalElement = document.getElementById('scheduleReportModal');
        if (scheduleModalElement) {
            scheduleModalElement.addEventListener('hidden.bs.modal', function () {
                const form = document.getElementById('scheduleReportForm');
                if (form) {
                    form.reset(); // Resets form fields to their initial values
                    form.action = "{{ url_for('admin.schedule_compliance_report') }}"; // Reset action URL
                }

                const modalLabel = document.getElementById('scheduleReportModalLabel');
                if (modalLabel) {
                    modalLabel.textContent = 'Schedule Recurring Report'; // Reset title
                }

                const scheduleBtn = document.getElementById('scheduleBtn');
                if (scheduleBtn) {
                    scheduleBtn.innerHTML = '<i class="bi bi-calendar-check me-1"></i> Schedule Report'; // Reset button text
                }

                // Reset frequency-dependent select visibility
                const weekdayContainer = document.getElementById('weekdaySelectContainer');
                const monthlyContainer = document.getElementById('monthlyDaySelectContainer');
                if (weekdayContainer) weekdayContainer.style.display = 'none';
                if (monthlyContainer) monthlyContainer.style.display = 'block'; // Default for 'monthly'

                const scheduleFrequencySelect = document.getElementById('schedule_frequency');
                if (scheduleFrequencySelect) scheduleFrequencySelect.value = 'monthly'; // Reset frequency to default
            });
        }
    });
</script>

<style>
    /* Custom styles for this page */
    .card-body .progress {
        height: 5px;
    }
</style>
{% endblock %}
