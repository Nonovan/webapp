# YARA Rules Collection

This directory contains YARA rule definitions used by the Forensic Analysis Toolkit for detecting malware during static analysis investigations. These rules enable pattern-based identification of suspicious code without executing potentially malicious files.

## Contents

- Overview
- Directory Structure
- Rule Categories
- Rule Format
- Usage
- Development Guidelines
- Testing Procedures
- Contributing
- Related Documentation

## Overview

The YARA rules collection provides pattern-based detection capabilities for identifying malware, suspicious code patterns, and indicators of compromise during forensic investigations. These rules support the static analysis tools by providing signature-based detection that complements hash-based and binary pattern detection methods. The rules are organized by malware category to facilitate targeted scanning and are regularly updated with new threat intelligence.

## Directory Structure

```plaintext
yara_rules/
├── README.md               # This documentation
├── backdoors/              # Rules for backdoor detection
│   ├── raw_shells.yar      # System shell backdoor detection rules
│   └── web_shells.yar      # Web shell detection rules
├── general/                # Generic malware detection
│   ├── evasion_techniques.yar  # Anti-analysis technique detection
│   ├── indicators.yar      # General malware indicators
│   └── suspicious_apis.yar  # Suspicious API usage patterns
└── ransomware/             # Ransomware detection rules
    ├── crypto_routines.yar # Encryption routine patterns
    ├── known_families.yar  # Known ransomware family signatures
    └── ransom_notes.yar    # Ransom note patterns
```

## Rule Categories

### Backdoor Rules

- **Web Shells**: Detection rules for various web shell implementations across different languages (PHP, ASP, JSP, etc.)
- **Raw Shells**: Rules for detecting system-level backdoors and reverse shells

### General Malware Rules

- **Evasion Techniques**: Rules for detecting anti-analysis techniques, sandbox evasion, and debugger detection
- **Suspicious API Usage**: Detection of suspicious API calls commonly used in malware
- **General Indicators**: Common patterns found across different malware families

### Ransomware Rules

- **Encryption Routines**: Rules for detecting cryptographic operations characteristic of ransomware
- **Known Families**: Signatures for specific ransomware families and variants
- **Ransom Notes**: Patterns for detecting ransom note templates and language

## Rule Format

YARA rules follow a structured format:

```yara
rule RuleIdentifier : RuleCategory
{
    meta:
        author      = "Security Team"
        description = "Detection of specific malware behavior"
        created     = "2024-07-15"
        updated     = "2024-07-20"
        confidence  = "high"
        reference   = "https://example.com/threat-report"
        sample      = "SHA-256 hash of reference sample"
        impact      = "critical"

    strings:
        $string1 = "suspicious string pattern"
        $string2 = { 8B 45 ?? 89 ?? ?? ?? 40 }  // Byte pattern
        $regex1 = /suspicious regex pattern/i

    condition:
        uint16(0) == 0x5A4D and  // MZ header
        filesize < 1MB and
        ($string1 or $string2 or $regex1)
}
```

## Usage

The YARA rules are used by the static analysis tools as follows:

```python
from static_analysis.common.signature_db import MalwareSignatureDB

# Initialize the malware signature database
malware_db = MalwareSignatureDB(
    db_root='admin/security/forensics/static_analysis/common/signature_db/malware'
)

# Perform YARA scan with specific rule categories
yara_matches = malware_db.yara_scan(
    file_path='path/to/suspicious_file',
    categories=['backdoors', 'ransomware']
)

if yara_matches:
    print(f"Detected {len(yara_matches)} YARA rule matches:")
    for match in yara_matches:
        print(f"- Rule: {match.rule_name}")
        print(f"  Category: {match.category}")
        print(f"  Description: {match.description}")
        print(f"  Confidence: {match.confidence}")
```

## Development Guidelines

### Rule Creation Guidelines

1. **Use Descriptive Names**: Rule names should be descriptive and follow naming conventions:
   - Use CamelCase for rule names
   - Include malware family or technique in name
   - Use appropriate prefixes for category (e.g., `Backdoor_`, `Ransomware_`)

2. **Complete Metadata**: Always include comprehensive metadata:
   - `author`: Rule creator
   - `description`: Clear description of what the rule detects
   - `created`: Initial creation date (YYYY-MM-DD)
   - `updated`: Last update date (YYYY-MM-DD)
   - `confidence`: Detection confidence (high, medium, low)
   - `reference`: Link to threat intelligence or analysis
   - `sample`: Hash of reference sample when available
   - `impact`: Severity level of the detected threat

3. **Optimize Performance**:
   - Start conditions with fast filters (file type, size)
   - Use anchored patterns when possible
   - Limit use of expensive regex operations
   - Consider file section restrictions for executables

4. **Minimize False Positives**:
   - Use multiple string matches in conditions
   - Test against benign sample set
   - Add context-specific conditions
   - Include file type verification when appropriate

### Testing Procedures

Before submitting new rules:

1. Test against known malicious samples
2. Validate against benign files to check for false positives
3. Measure performance impact
4. Document any edge cases or limitations
5. Verify compatibility with existing rules

## Contributing

To contribute new YARA rules:

1. Follow the development guidelines above
2. Test thoroughly using the testing procedures
3. Create a pull request with:
   - Clear description of the detection capability
   - Sample hashes for verification (if possible)
   - Performance metrics from testing
   - False positive analysis results

## Related Documentation

- Static Analysis Tools Guide
- Forensic Analysis Toolkit
- [YARA Documentation](https://yara.readthedocs.io/)
- Malware Analysis Methodology
- Threat Intelligence Integration
- Signature Development Process
