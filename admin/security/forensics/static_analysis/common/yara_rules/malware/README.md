# Malware Detection YARA Rules

This directory contains YARA rules specifically designed to detect various types of malware during forensic analysis of suspicious files and artifacts. These rules help security teams identify malicious software during incident response investigations.

## Contents

- Overview
- Rule Categories
- Rule Structure
- Usage
- Development Guidelines
- Testing Procedures
- Contributing
- Related Documentation

## Overview

The malware detection YARA rules provide pattern-based detection capabilities specifically targeting known malware families, behaviors, and techniques. These rules complement other detection methods in the Forensic Analysis Toolkit by focusing on specific malware characteristics. Each rule is designed to minimize false positives while effectively identifying malicious code.

## Rule Categories

The malware detection rules are organized into several categories:

- **Trojan Malware**: Rules for detecting trojan horses and backdoors
- **Ransomware**: Rules specific to ransomware payloads and components
- **Information Stealers**: Rules for detecting credential theft and data exfiltration malware
- **Banking Malware**: Rules targeting financial fraud malware
- **RATs (Remote Access Trojans)**: Rules for remote control malware
- **Rootkits**: Rules for detecting system persistence and hiding techniques
- **Downloaders/Droppers**: Rules for identifying malware installation components
- **Exploit Kits**: Rules for exploit delivery frameworks

## Rule Structure

Each YARA rule follows a consistent structure:

```yara
rule Malware_Family_Component {
    meta:
        description = "Detects specific malware family or component"
        author = "Security Team"
        date = "YYYY-MM-DD"
        version = "1.0"
        hash = "SHA-256 hash of reference sample"
        severity = "critical|high|medium|low"
        family = "Malware family name"
        mitre_att = "Relevant MITRE ATT&CK technique ID"

    strings:
        // String patterns unique to this malware
        $string1 = "Unique malware string"
        $string2 = { DE AD BE EF } // Hex pattern
        $regex1 = /suspicious pattern with wildcards/

        // Additional context patterns that help confirm
        $context1 = "Supporting evidence string"

    condition:
        // Condition logic to minimize false positives
        uint16(0) == 0x5A4D and // MZ header for PE files
        filesize < 5MB and
        (
            2 of ($string*) or
            ($string1 and $context1) or
            $regex1
        )
}
```

## Usage

These YARA rules are used by the static analysis tools as follows:

```python
from static_analysis.common.yara_utils import YaraScanner

# Initialize scanner with malware-specific rules
scanner = YaraScanner(
    rule_paths=["admin/security/forensics/static_analysis/common/yara_rules/malware"]
)

# Scan a suspicious file
results = scanner.scan_file("/path/to/suspicious_file")

# Process results
if results:
    print(f"Found {len(results)} malware matches:")
    for match in results:
        print(f"- Rule: {match.rule}")
        print(f"  Malware family: {match.meta.get('family', 'Unknown')}")
        print(f"  Severity: {match.meta.get('severity', 'Unknown')}")
        print(f"  Description: {match.meta.get('description', 'No description')}")
        print(f"  MITRE ATT&CK: {match.meta.get('mitre_att', 'N/A')}")
```

## Development Guidelines

When creating new malware detection rules:

1. **Research Thoroughly**
   - Analyze multiple samples of the malware
   - Identify unique and persistent characteristics
   - Document behavior and technical details

2. **Create Specific Rules**
   - Target unique malware characteristics
   - Avoid patterns common in legitimate software
   - Include sufficient context to minimize false positives
   - Use multiple string patterns when possible

3. **Document Properly**
   - Include full metadata for each rule
   - Reference sample hashes and sources
   - Document MITRE ATT&CK techniques when applicable
   - Include severity assessment

4. **Follow Naming Conventions**
   - Use descriptive names that identify the malware family
   - Follow the format: `Malware_Family_Component`
   - Include variant information when applicable
   - Be consistent with existing rule naming

## Testing Procedures

Before submitting new rules:

1. **Positive Testing**
   - Verify detection against known malware samples
   - Test against multiple variants when possible
   - Document detection effectiveness

2. **Negative Testing**
   - Test against clean files to verify no false positives
   - Include testing against similar benign software
   - Perform broad testing across file types

3. **Performance Testing**
   - Evaluate impact on scanning performance
   - Optimize rules that cause significant slowdowns
   - Balance detection quality with performance

## Contributing

To contribute new malware detection rules:

1. Follow the development guidelines and testing procedures
2. Ensure rules have been tested against both malicious and benign samples
3. Document the malware's behavior and characteristics
4. Include reference sample hashes (preferably SHA-256)
5. Submit a pull request with clear descriptions of the detection capabilities

## Related Documentation

- YARA Rule Development Guide
- Malware Analysis Methodology
- Static Analysis Tools
- Forensic Analysis Toolkit
- Incident Response Procedures
- [MITRE ATT&CK Framework](https://attack.mitre.org/)
